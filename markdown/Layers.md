# Слои

## Что такое слой?

**Слой** - это уровень абстракции, на котором решаются определённые задачи. Каждый слой отвечает за свою часть логики и взаимодействует с другими слоями только через чётко определённые интерфейсы.

## Для чего нужны слои?

Выделять слои нужно для упрощения разработки, сопровождения, тестирования и масштабирования приложения.

-   Разделение ответственности.

    -   Каждый слой отвечает только за свою задачу (UI, бизнес-логика, данные), и ни за что лишнее.
    -   Проще понять, где искать ошибку или куда добавлять новый функционал.

-   Переиспользование кода.

    Например, бизнес-логику можно использовать в разных вариантах интерфейса (в десктопном-вебе, мобильном-вебе, да даже в другом приложении).

-   Облегчение тестирования.

    -   По слоям легко писать отдельные юнит-тесты: для бизнес-логики - одни, для UI - другие.
    -   Нет зависимости теста одного слоя от других.

-   Упростить сопровождение и развитие.

    -   При изменениях или добавлении новой функциональности изменения затрагивают минимум слоёв.
    -   Улучшение или рефакторинг одного слоя не влияет на работу других (если соблюдены интерфейсы).

-   Возможность замены технологий.

    Можно заменить конкретную технологию реализации слоя (например, другую библиотеку для хранения состояния или новый способ обращения к API) без переписывания всего приложения.

-   Улучшение структуры и читаемости

    -   Проект становится структурированным, легко ориентироваться в большом коде.
    -   Новым разработчикам легче подключаться к проекту.

-   Снижение сложности крупного приложения.

    Когда проект растёт, без слоёв код смешивается (spaghetti code), поддерживать становится сложно.

## Как разделить приложение на слои?

**Базовый набор слоёв**:

-   UI - логика отображения;
-   Бизнес логика;
-   Данные;
-   API.

### UI - логика отображения

UI-слой (User Interface Layer) - это уровень приложения, который отвечает за отображение данных, взаимодействие с пользователем (кнопки, формы, списки и т.д.), обработку пользовательских событий (нажатия, ввод текста и т.п.), а также за перевод данных в визуальную форму.

**UI Что входит?**

-   **React-компоненты**, которые отвечают за конкретные части интерфейса: кнопки, поля ввода, карточки, страницы, хедеры, меню и т.д.

-   **Стилизация компонентов** (CSS, CSS-in-JS, Styled Components и прочее).

-   **Обработка простых пользовательских событий** (onClick, onChange и т.д.).

-   **Локальная логика управления UI** - например, раскрытие/закрытие модалки, переключение вкладок, состояние фокуса, открытие-скрытие меню.

**UI Что не входит?**

-   **Бизнес-логика** - всякие вычисления, связанные с правилами предметной области (например, подсчёт итоговой суммы заказа с учётом всех скидок, проверка бизнес-правил и ограничений).

-   **Извлечение данных** из внешних источников (API-запросы, работа с бэкендом, локальное и асинхронное хранилище).

-   **Работа с глобальным состоянием** - если логика работы со стейтом общая для многих компонентов (например, корзина товаров, авторизация), она обычно выносится в слой данных.

-   **Валидация данных по бизнес-правилам** - если логика сложная (например, email разрешен только для определенной доменной зоны), это не задача UI.

**UI Как определить?**

-   Будет ли это нужно, если изменить дизайн? (Да - UI).

-   Зависит ли это от React? (Да - UI).

-   Можно ли это протестировать скриншотными тестами? (Да - UI).

-   Зависит ли эта логика от предметной области продукта? (Да - НЕ UI).

-   Меняется ли это поведение в зависимости от данных пользователя/компании/процесса? (Да - НЕ UI, это бизнес-логика).

### Бизнес-логика

Слой бизнес-логики (Business Logic Layer / Domain Layer) - это уровень клиентского (или серверного) приложения, который отвечает за реализацию правил, процессов сценариев, характерных для данной предметной области (бизнеса). Здесь принимаются решения, которые важны с точки зрения работы основного функционала приложения, а не только его внешнего вида.

**Бизнес-логика Что входит?**

-   **Правила и ограничения бизнеса**.

    Примеры: нельзя оформить заказ, если товаров на складе недостаточно; нельзя провести оплату, если баланс меньше нуля; доступ к функциональности только для определённых ролей.

-   **Вычисления, специфичные для продукта**

    Примеры: расчёт итоговой стоимости с применением скидок, бонусов: формирование итогового списка товаров; автоматическое определение статуса заказа на основе набора условий.

-   **Оркестрирование процессов**

    Примеры: многошаговые проверки (валидация формы с зависимостями между полями), сценарии "если X, то Y, иначе Z".

-   **Агрегация и подготовка данных для UI**

    Примеры: трансформация данных с бэкенда, фильтрация и группировка данных по бизнес-правилам перед отправкой в компонент.

**Бизнес-логика Что не входит?**

-   **Конкретные детали отрисовки и взаимодействие с DOM**

    Примеры: скрывать/показывать спиннер, управлять состояниями UI-компонентов (открыто/закрыто), изменять стили.

-   **Транспортировка и хранение данных**

    Примеры: запросы к серверу, сохранение в localStorage, кэширование.

-   **Локальная UI-логика**

    Примеры: переключение вкладок, анимации переключений, фокус, подсветка элемента.

**Бизнес-логика Как определить?**

-   Может использоваться в разных "фронтах" (например, будет нужна и для сайта, и для мобильного приложения) - это бизнес логика.

-   При изменении бизнес-процессов/правил будет меняться даже при том, что UI выглядит так же - это бизнес логика.

-   Завязана на сущности приложения (пользователь, заказ, роли, состояния бизнес-объекта) - это бизнес-логика.

-   Определяет результат работы пользовательских сценариев, но не то, как они отображаются ("прошла ли валидация заказа" - бизнес логика, "подсветить ошибку красным" - UI).

-   Бизнес-логика не должна знать ничего о React, DOM, хуках и компонентах.

-   Если при переписывании приложения на другой фреймворк (Vue, Angular) или переносе части сценариев на сервер, логика тоже потребуется - это бизнес-логика.

Бизнес-логика - это "мозги" приложения, место, где описывается, "как правильно" всё работает, вне зависимости от внешнего вида. Её хорошо держать отдельно, чтобы логику можно было тестировать, переиспользовать, расширять и поддерживать независимо от UI или слоя данных.

### Данные

**Слой данных** (Data Layer / Data Access Layer) - это уровень приложения, который отвечает за получение, хранение и обновление данных из внешних источников (API, серверы, локальное хранилище и т.п.), а также за подготовку и трансформацию этих данных для передачи в бизнес-логику или UI. Этот слой инкапсулирует все детали взаимодействия с источниками данных.

Слой данных можно разделить на два отдельных слоя:

-   Слой управления данными (State Management Layer);

-   Слой доступа к API (API Layer/Data Access Layer).

**State Management Layer**

Это слой, который отвечает за хранение, изменение и предоставление состояния приложения (данных) для компонентов.

Этот слой часто реализуется через Flux, Redux, MobX, Zustand, Recoil, Effector и т.д.

**State Management Layer Что входит?**

-   **Стейт приложения** (например, корзина, пользователь, товары, настройки), которым должны делиться несколько компонентов.

-   **Логика изменения состояния** через различные механизмы.

-   **Логика получения состояния** - селекторы (функции для получения нужных "кусков" состояния) и т.д.

-   **Реакция на изменения данных** - подписки, эффекты.

-   **Интеграция с API-слоем**.

**State Management Layer Что не входит?**

-   Прямое выполнение HTTP-запросов к серверу.

-   Отрисовка контента и другие UI-задачи.

-   Бизнес-правила - они должны быть вынесены отдельно или использоваться через промежуточные слои.

**State Management Layer Как определить?**

-   Нужно ли это состояние в нескольких местах приложения? (Да - стор).

-   Можно ли это заменить на useState без потерь? (Нет - стор).

### API

Слой доступа к API - это слой, который инкапсулирует все операции для взаимодействия с внешними источниками данных (бэкенд-сервера, third-party сервисы, firebase и т.д.), реализуя запросы, обработку результатов и ошибок, а также возможно - кэширование.

**API Layer Что входит?**

-   **Реализация HTTP-запросов** (fetch, axios, graphql-request и т.п.).

-   **Функции получения, добавления, изменения, удаления данных** (api/getTodos, api/createUser и т.д.).

-   **Обработка ошибок и статусов** (повторы, обработка таймаутов, парсинг ответов).

**API Layer Что не входит?**

-   Управление состоянием приложения и синхронизация между компонентами.

-   UI отрисовка и обработка событий.

-   Бизнес-правила и специфическая предметная логика.

## Итоги по слоям

### Как взаимодействуют слои

-   Пользователь жмёт "добавить заметку" в UI.

-   **UI Layer** вызывает экшен addNote у **State Management Layer**.

-   **State Management Layer** вызывает функцию addNote(content) из **Business Logic Layer**.

-   **Business Logic Layer**:

    -   Достаёт текущие заметки из **API Layer** (getNotes).
    -   Применяет бизнес-правила (ограничения, валидация).
    -   Если всё ОК, формирует новую пачку заметок и передаёт в **API Layer** для сохранения (setNotes).
    -   Возвращает обновлённый список заметок (или ошибку) в State Management.

-   **State Management Layer** обновляет состояние - теперь все подписанные компоненты UI получат актуальные данные.

-   **UI Layer** автоматически отрисует новые известные ему данные из стора.
